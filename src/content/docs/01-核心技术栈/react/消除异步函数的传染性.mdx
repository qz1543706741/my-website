---
title: æ¶ˆé™¤å¼‚æ­¥å‡½æ•°çš„ä¼ æŸ“æ€§
---

import { ShowResult } from '@/components/ShowResult';

## ä¸ºå•¥è¦å­¦è¿™ä¸ª

å…ˆçœ‹çœ‹è¿™ä¸ªä¾‹å­ï¼š

```javascript
function ArtistPage({ artist }) {
  return (
    <Suspense fallback={<h2>ğŸŒ€ Loading...</h2>}>
      <Albums artistId={artist.id} />
    </Suspense>
  );
}

function Albums({ artistId }) {
  const albums = React.use(fetchData(`/${artistId}/albums`));
  return (
    <ul>
      {albums.map((album) => (
        <li key={album.id}>
          {album.title} ({album.year})
        </li>
      ))}
    </ul>
  );
}
```

:::tip[é‚£ä¹ˆé—®é¢˜æ¥äº†]
`Albums` æ˜¯ä¸ªåŒæ­¥å‡½æ•°ï¼ˆè¿”å›çš„ä¸æ˜¯ `Promise`ï¼‰ï¼Œé‚£ä¸ºå•¥ `Suspense` èƒ½å¤ŸçŸ¥é“ `Albums` ç»„ä»¶å†… `Promise` çŠ¶æ€å‘¢ï¼Ÿ
:::

```javascript
function getBaiduText() {
  return window.fetch('https://www.baidu.com/');
}

function main() {
  console.log('run main');
  const text1 = getBaiduText();
  console.log('getBaiduText 1:', text1);
  const text2 = getBaiduText();
  console.log('getBaiduText 2:', text2);
}

function run(func) {
  /************************** ä¿å­˜æ—§çš„ fetch ****************************/
  const oldFetch = window.fetch;

  /************************** é‡å†™ fetch ****************************/
  const cache = {
    status: '', // '' | 'pending' | 'fulfilled' | 'rejected'
    value: null,
  };

  const newFetch = (...args) => {
    if (cache.status === 'fulfilled') return cache.value;
    if (cache.status === 'rejected') throw new Error(cache.value);
    const p = oldFetch(...args)
      .then((res) => {
        return res.text();
      })
      .then((res) => {
        cache.status = 'fulfilled';
        cache.value = res;
      })
      .catch((err) => {
        cache.status = 'rejected';
        cache.value = err;
      });
    throw p;
  };

  window.fetch = newFetch;

  /************************** æ‰§è¡Œå‡½æ•° ****************************/
  try {
    func();
  } catch (error) {
    if (error instanceof Promise) {
      error.finally(() => {
        window.fetch = newFetch;
        func();
        window.fetch = oldFetch;
      });
    }
  }

  /************************** æ¢å¤ fetch ****************************/
  window.fetch = oldFetch;
}

run(main);
```

<ShowResult
  client:only
  result={`
   console.log('getBaiduText 1:', text1);
   console.log('getBaiduText 2:', text1);
`}
/>
